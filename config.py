# config.py
import os
import rarfile
import logging
from pathlib import Path

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    encoding='utf-8'
)

logger = logging.getLogger(__name__)


def load_config_from_env():
    """从环境变量加载配置

    支持的环境变量:
    - NSFW_THRESHOLD: NSFW检测阈值 (float, 默认0.8)
    - FFMPEG_MAX_FRAMES: FFmpeg最大帧数 (int, 默认20)
    - FFMPEG_MAX_TIMEOUT / FFMPEG_TIMEOUT: FFmpeg超时时间 (int, 默认1800秒)
    - AUTH_TOKEN: API认证Token (string, 默认None)
    - CHECK_ALL_FILES: 是否检查所有文件 (int, 默认0)
    - MAX_INTERVAL_SECONDS: 最大间隔秒数 (int, 默认30)
    - MAX_FILE_SIZE: 最大文件大小 (int, 默认20GB)
    """
    env_config = {}
    env_loaded = {}

    # 定义环境变量映射: 环境变量名 -> (配置键名, 类型转换函数)
    env_mappings = {
        'NSFW_THRESHOLD': ('NSFW_THRESHOLD', float),
        'FFMPEG_MAX_FRAMES': ('FFMPEG_MAX_FRAMES', int),
        'FFMPEG_MAX_TIMEOUT': ('FFMPEG_TIMEOUT', int),  # FFMPEG_MAX_TIMEOUT 映射到 FFMPEG_TIMEOUT
        'FFMPEG_TIMEOUT': ('FFMPEG_TIMEOUT', int),
        'AUTH_TOKEN': ('AUTH_TOKEN', str),
        'CHECK_ALL_FILES': ('CHECK_ALL_FILES', int),
        'MAX_INTERVAL_SECONDS': ('MAX_INTERVAL_SECONDS', int),
        'MAX_FILE_SIZE': ('MAX_FILE_SIZE', int),
    }

    for env_var, (config_key, type_func) in env_mappings.items():
        value = os.environ.get(env_var)
        if value is not None:
            try:
                # 特殊处理AUTH_TOKEN: 空字符串视为None
                if config_key == 'AUTH_TOKEN':
                    if value.strip() == '':
                        env_config[config_key] = None
                    else:
                        env_config[config_key] = value.strip()
                else:
                    env_config[config_key] = type_func(value)
                env_loaded[env_var] = env_config[config_key]
            except ValueError as e:
                logger.warning(f"环境变量 {env_var} 的值 '{value}' 无法转换为 {type_func.__name__}: {e}")

    return env_config, env_loaded

# 基础配置
rarfile.UNRAR_TOOL = "unrar"
rarfile.PATH_SEP = '/'
os.environ['HF_HOME'] = '/root/.cache/huggingface'

# MIME类型到文件扩展名的映射
# config.py 中的 MIME_TO_EXT 字典应该这样修改：

# MIME类型到文件扩展名的映射
MIME_TO_EXT = {
    # 图片格式
    'image/jpeg': '.jpg',
    'image/png': '.png',
    'image/gif': '.gif',
    'image/webp': '.webp',
    'image/bmp': '.bmp',
    'image/tiff': '.tiff',
    'image/x-tiff': '.tiff',
    'image/x-tga': '.tga',
    'image/x-portable-pixmap': '.ppm',
    'image/x-portable-graymap': '.pgm',
    'image/x-portable-bitmap': '.pbm',
    'image/x-portable-anymap': '.pnm',
    'image/svg+xml': '.svg',
    'image/x-pcx': '.pcx',
    'image/vnd.adobe.photoshop': '.psd',
    'image/vnd.microsoft.icon': '.ico',
    'image/heif': '.heif',
    'image/heic': '.heic',
    'image/avif': '.avif',
    'image/jxl': '.jxl',

    # PDF格式
    'application/pdf': '.pdf',

    # 文档格式 (新增)
    'application/msword': '.doc',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',

    # 视频和容器格式
    'video/mp4': '.mp4',
    'video/x-msvideo': '.avi',
    'video/x-matroska': '.mkv',
    'video/quicktime': '.mov',
    'video/x-ms-wmv': '.wmv',
    'video/webm': '.webm',
    'video/MP2T': '.ts',
    'video/x-flv': '.flv',
    'video/3gpp': '.3gp',
    'video/3gpp2': '.3g2',
    'video/x-m4v': '.m4v',
    'video/mxf': '.mxf',
    'video/x-ogm': '.ogm',
    'video/vnd.rn-realvideo': '.rv',
    'video/dv': '.dv',
    'video/x-ms-asf': '.asf',
    'video/x-f4v': '.f4v',
    'video/vnd.dlna.mpeg-tts': '.m2ts',
    'video/x-raw': '.yuv',
    'video/mpeg': '.mpg',
    'video/x-mpeg': '.mpeg',
    'video/divx': '.divx',
    'video/x-vob': '.vob',
    'video/x-m2v': '.m2v',

    # 压缩格式
    'application/x-rar-compressed': '.rar',
    'application/x-rar': '.rar',
    'application/vnd.rar': '.rar',
    'application/zip': '.zip',
    'application/x-7z-compressed': '.7z',
    'application/gzip': '.gz',
    'application/x-tar': '.tar',
    'application/x-bzip2': '.bz2',
    'application/x-xz': '.xz',
    'application/x-lzma': '.lzma',
    'application/x-zstd': '.zst',
    'application/vnd.ms-cab-compressed': '.cab'
}

# 文件扩展名集合
IMAGE_EXTENSIONS = {'.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tiff', '.tga',
                   '.ppm', '.pgm', '.pbm', '.pnm', '.svg', '.pcx', '.psd', '.ico',
                   '.heif', '.heic', '.avif', '.jxl'}

VIDEO_EXTENSIONS = {'.mp4', '.avi', '.mkv', '.mov', '.wmv', '.webm', '.ts', '.flv',
                   '.3gp', '.3g2', '.m4v', '.mxf', '.ogm', '.rv', '.dv', '.asf',
                   '.f4v', '.m2ts', '.yuv', '.mpg', '.mpeg', '.divx', '.vob', '.m2v'}

ARCHIVE_EXTENSIONS = {'.7z', '.rar', '.zip', '.gz', '.tar', '.bz2', '.xz',
                     '.lzma', '.zst', '.cab'}

# 添加新的文档扩展名集合
DOCUMENT_EXTENSIONS = {'.doc', '.docx'}

# 添加新的 MIME 类型集合
DOCUMENT_MIME_TYPES = {
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
}

# MIME 类型集合
IMAGE_MIME_TYPES = {mime for mime, ext in MIME_TO_EXT.items() if mime.startswith('image/')}
VIDEO_MIME_TYPES = {mime for mime, ext in MIME_TO_EXT.items() if mime.startswith('video/')}
ARCHIVE_MIME_TYPES = {mime for mime, ext in MIME_TO_EXT.items() if
    mime.startswith('application/') and
    any(keyword in mime for keyword in ['zip', 'rar', '7z', 'gzip', 'tar',
        'bzip2', 'xz', 'lzma', 'zstd', 'cab'])}
PDF_MIME_TYPES = {'application/pdf'}

# 所有支持的 MIME 类型集合
SUPPORTED_MIME_TYPES = IMAGE_MIME_TYPES | VIDEO_MIME_TYPES | ARCHIVE_MIME_TYPES | PDF_MIME_TYPES | DOCUMENT_MIME_TYPES

# 默认配置值
MAX_FILE_SIZE = 20 * 1024 * 1024 * 1024  # 20GB
NSFW_THRESHOLD = 0.8
FFMPEG_MAX_FRAMES = 20
FFMPEG_TIMEOUT = 1800
CHECK_ALL_FILES = 0
MAX_INTERVAL_SECONDS = 30
AUTH_TOKEN = None  # API认证Token，设置后需要在请求头中携带Token

# 从环境变量加载配置
env_config, env_loaded = load_config_from_env()

# 更新全局变量
globals().update(env_config)

# 记录生效的配置
logger.info("当前生效的配置:")
logger.info("-" * 50)
final_nsfw = env_config.get('NSFW_THRESHOLD', NSFW_THRESHOLD)
final_frames = env_config.get('FFMPEG_MAX_FRAMES', FFMPEG_MAX_FRAMES)
final_timeout = env_config.get('FFMPEG_TIMEOUT', FFMPEG_TIMEOUT)
final_token = env_config.get('AUTH_TOKEN', AUTH_TOKEN)
logger.info(f"{'NSFW_THRESHOLD':25s} = {final_nsfw}")
logger.info(f"{'FFMPEG_MAX_FRAMES':25s} = {final_frames}")
logger.info(f"{'FFMPEG_TIMEOUT':25s} = {final_timeout}")
logger.info(f"{'AUTH_TOKEN':25s} = {'***' if final_token else 'None'}")
if env_loaded:
    logger.info("-" * 50)
    logger.info("以上配置来自环境变量覆盖")

# 导出所有配置变量
__all__ = [
    'MIME_TO_EXT', 'IMAGE_EXTENSIONS', 'VIDEO_EXTENSIONS', 'ARCHIVE_EXTENSIONS',
    'DOCUMENT_EXTENSIONS',  # 新增
    'IMAGE_MIME_TYPES', 'VIDEO_MIME_TYPES', 'ARCHIVE_MIME_TYPES', 'PDF_MIME_TYPES',
    'DOCUMENT_MIME_TYPES',  # 新增
    'SUPPORTED_MIME_TYPES', 'MAX_FILE_SIZE', 'NSFW_THRESHOLD', 'FFMPEG_MAX_FRAMES',
    'FFMPEG_TIMEOUT', 'CHECK_ALL_FILES', 'MAX_INTERVAL_SECONDS', 'AUTH_TOKEN'
]